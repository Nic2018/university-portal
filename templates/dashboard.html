<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Campus Booking</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        /* BODY BACKGROUND (Fintech Blue) */
        body {
            display: flex; height: 100vh;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            overflow: hidden;
        }

        /* SIDEBAR (Glass Effect) */
        .sidebar { 
            width: 90px; 
            background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; flex-direction: column; align-items: center; padding: 30px 0; z-index: 100; 
        }

        .sidebar-icon { 
            width: 50px; height: 50px; border-radius: 14px; 
            display: flex; justify-content: center; align-items: center; 
            color: #94a3b8; font-size: 1.3rem; margin-bottom: 25px; 
            transition: all 0.3s ease; text-decoration: none; position: relative; 
        }
        .sidebar-icon:hover { background: rgba(255, 255, 255, 0.1); color: #ffffff; transform: translateY(-2px); }
        .sidebar-icon.active { background: linear-gradient(135deg, #4a6cf7 0%, #3451c7 100%); color: white; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
        .sidebar-icon.logout { margin-top: auto; color: #ff6b6b; } 
        .sidebar-icon.logout:hover { background: rgba(255, 85, 85, 0.1); color: #ff6b6b; }
        .sidebar-icon::after { content: attr(data-tooltip); position: absolute; left: 75px; top: 50%; transform: translateY(-50%) translateX(10px); background-color: #2d3436; color: white; padding: 6px 14px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; white-space: nowrap; opacity: 0; visibility: hidden; transition: 0.2s; pointer-events: none; z-index: 100; }
        .sidebar-icon:hover::after { opacity: 1; visibility: visible; transform: translateY(-50%) translateX(0); }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; background: transparent; }

        .header { margin-bottom: 30px; }
        .header h1 { font-size: 2rem; font-weight: 700; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header p { color: #e0e7ff; font-size: 1rem; margin-top: 5px; }

        /* ACTION CARDS */
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .action-card {
            background: white; border-radius: 20px; padding: 25px; display: flex; align-items: center; gap: 20px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2); text-decoration: none; transition: 0.3s; border: none;
        }
        .action-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3); }
        .icon-box { width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .icon-blue { background: #e0f2fe; color: #0284c7; }
        .icon-purple { background: #f3e8ff; color: #9333ea; }
        .icon-green { background: #dcfce7; color: #16a34a; }
        .card-info h3 { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
        .card-info span { color: #64748b; font-size: 0.85rem; font-weight: 500; }

        /* --- NEW DASHBOARD GRID (MAP + CHART) --- */
        .dashboard-row { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; height: 450px; }
        
        /* On small screens, stack them */
        @media (max-width: 1000px) { .dashboard-row { grid-template-columns: 1fr; height: auto; } }

        /* Generic Glass/White Card */
        .dashboard-card {
            background: white; border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2); display: flex; flex-direction: column;
        }

        .card-header { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { font-size: 1.1rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 10px; }
        
        #campus-map { flex: 1; width: 100%; border-radius: 16px; min-height: 300px; }
        .chart-container { position: relative; flex: 1; display: flex; justify-content: center; align-items: center; }

        /* Chatbot Styles */
        @keyframes floatUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        #chat-messages::-webkit-scrollbar { width: 5px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <a href="#" class="sidebar-icon active" data-tooltip="Dashboard"><i class="fas fa-home"></i></a>
        <a href="{% url 'my_bookings' %}" class="sidebar-icon" data-tooltip="My Bookings"><i class="fas fa-list-ul"></i></a>
        <a href="{% url 'calendar' %}" class="sidebar-icon" data-tooltip="View Schedule"><i class="fas fa-calendar-alt"></i></a>
        <a href="{% url 'venue_list' %}" class="sidebar-icon" data-tooltip="Campus Venues"><i class="fas fa-map-marker-alt"></i></a>
        <a href="{% url 'create_booking' %}" class="sidebar-icon" data-tooltip="Book a Room"><i class="fas fa-plus"></i></a>
        <a href="{% url 'profile' %}" class="sidebar-icon" data-tooltip="Settings"><i class="fas fa-user-cog"></i></a>
        {% if user.username == 'guest' %}
            <a href="{% url 'logout' %}" class="sidebar-icon logout" data-tooltip="Register Now"><i class="fas fa-user-plus"></i></a>
        {% else %}
            <a href="{% url 'logout' %}" class="sidebar-icon logout" data-tooltip="Log Out"><i class="fas fa-sign-out-alt"></i></a>
        {% endif %}
    </div>

    <div class="main-content">
        
        <div class="header">
            <h1>Welcome, {{ user.first_name|default:user.username }}! üëã</h1>
            <p>Here's your campus booking dashboard.</p>
        </div>

        <div class="action-grid">
            <a href="{% url 'venue_list' %}" class="action-card">
                <div class="icon-box icon-blue"><i class="fas fa-search"></i></div>
                <div class="card-info"><h3>Find</h3><span>Search Venues</span></div>
            </a>
            <a href="{% url 'create_booking' %}" class="action-card">
                <div class="icon-box icon-purple"><i class="fas fa-plus"></i></div>
                <div class="card-info"><h3>Book</h3><span>New Reservation</span></div>
            </a>
            <a href="{% url 'my_bookings' %}" class="action-card">
                <div class="icon-box icon-green"><i class="fas fa-calendar-check"></i></div>
                <div class="card-info"><h3>Check</h3><span>My Status</span></div>
            </a>
        </div>

        <div class="dashboard-row">
            
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-map-marked-alt" style="color: #4a6cf7;"></i> Campus Map</h3>
                    <span style="color: #64748b; font-size: 0.9rem;">Live View</span>
                </div>
                <div id="campus-map"></div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-pie" style="color: #db2777;"></i> My Stats</h3>
                </div>
                
                <div class="chart-container">
                    <canvas id="myChart"></canvas>
                </div>

                <div style="margin-top: 15px; text-align: center;">
                    <span style="color: #94a3b8; font-size: 0.85rem;">Total Bookings: <b>{{ a_count|add:p_count|add:r_count }}</b></span>
                </div>
            </div>

        </div>

    </div>

    <button id="chat-toggle" onclick="toggleChat()" style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #4a6cf7 0%, #3451c7 100%); color: white; border: none; font-size: 1.5rem; box-shadow: 0 10px 25px rgba(74, 108, 247, 0.4); cursor: pointer; z-index: 1000; transition: 0.3s; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-robot"></i>
    </button>

    <div id="chat-window" style="display: none; position: fixed; bottom: 100px; right: 30px; width: 350px; height: 450px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); z-index: 1000; flex-direction: column; overflow: hidden; animation: floatUp 0.3s ease-out;">
        <div style="background: linear-gradient(135deg, #4a6cf7, #3451c7); padding: 15px; color: white; display: flex; align-items: center;">
            <div style="width: 35px; height: 35px; background: white; border-radius: 50%; color: #4a6cf7; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                <i class="fas fa-robot" style="font-size: 1rem;"></i>
            </div>
            <div>
                <h4 style="margin: 0; font-size: 1rem; font-weight: 600;">CampusBot</h4>
                <span style="font-size: 0.75rem; opacity: 0.8;">‚óè Online</span>
            </div>
            <i class="fas fa-times" onclick="toggleChat()" style="margin-left: auto; cursor: pointer;"></i>
        </div>
        <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; background: rgba(240, 244, 255, 0.5);">
            <div style="margin-bottom: 10px; display: flex; justify-content: flex-start;">
                <div style="background: white; padding: 10px 15px; border-radius: 15px 15px 15px 0; font-size: 0.9rem; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 80%;">
                    Hi! üëã Ask me about venue availability or recommendations.
                </div>
            </div>
        </div>
        <div style="padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px;">
            <input type="text" id="user-input" placeholder="Type a message..." style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 20px; outline: none; font-size: 0.9rem;" onkeypress="handleEnter(event)">
            <button onclick="sendMessage()" style="width: 40px; height: 40px; background: #4a6cf7; color: white; border: none; border-radius: 50%; cursor: pointer; transition: 0.2s;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- 1. MAP INITIALIZATION ---
        var map = L.map('campus-map').setView([3.140853, 101.693207], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
        L.marker([3.1412, 101.6925]).addTo(map).bindPopup("<b>Block A</b><br>Lecture Halls");
        L.marker([3.1405, 101.6935]).addTo(map).bindPopup("<b>Block B</b><br>Faculty Offices");
        L.marker([3.1400, 101.6930]).addTo(map).bindPopup("<b>Main Library</b><br>Study Areas");

        // --- 2. CHART.JS INITIALIZATION (Analytics) ---
        // Get data from Django Context
        var pCount = {{ p_count|default:0 }};
        var aCount = {{ a_count|default:0 }};
        var rCount = {{ r_count|default:0 }};

        // If no data, show dummy data so chart looks nice
        if (pCount === 0 && aCount === 0 && rCount === 0) {
            // Optional: Dummy data for Guests or Empty users
            // pCount = 1; aCount = 2; rCount = 0; 
        }

        var ctx = document.getElementById('myChart').getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Approved', 'Pending', 'Rejected'],
                datasets: [{
                    data: [aCount, pCount, rCount],
                    backgroundColor: [
                        '#16a34a', // Green
                        '#d97706', // Orange
                        '#dc2626'  // Red
                    ],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                },
                cutout: '70%' // Makes it a thin ring
            }
        });

        // --- 3. CHATBOT LOGIC ---
        function toggleChat() {
            var chat = document.getElementById("chat-window");
            chat.style.display = (chat.style.display === "none") ? "flex" : "none";
        }
        function handleEnter(e) { if (e.key === "Enter") sendMessage(); }
        function sendMessage() {
            var input = document.getElementById("user-input");
            var message = input.value.trim();
            if (message === "") return;
            addMessage(message, 'user');
            input.value = "";
            var loadingId = addLoading();
            fetch("{% url 'ai_chat' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ "message": message })
            })
            .then(response => response.json())
            .then(data => { removeLoading(loadingId); addMessage(data.response, 'bot'); })
            .catch(error => { removeLoading(loadingId); addMessage("‚ö†Ô∏è Error.", 'bot'); });
        }
        function addMessage(text, sender) {
            var chatDiv = document.getElementById("chat-messages");
            var msgDiv = document.createElement("div");
            msgDiv.style.display = "flex";
            msgDiv.style.marginBottom = "10px";
            msgDiv.style.justifyContent = sender === 'user' ? "flex-end" : "flex-start";
            var bubble = document.createElement("div");
            bubble.style.padding = "10px 15px";
            bubble.style.fontSize = "0.9rem";
            bubble.style.maxWidth = "80%";
            bubble.style.boxShadow = "0 2px 5px rgba(0,0,0,0.05)";
            if (sender === 'user') { bubble.style.background = "#4a6cf7"; bubble.style.color = "white"; bubble.style.borderRadius = "15px 15px 0 15px"; }
            else { bubble.style.background = "white"; bubble.style.color = "#333"; bubble.style.borderRadius = "15px 15px 15px 0"; }
            bubble.innerText = text;
            msgDiv.appendChild(bubble);
            chatDiv.appendChild(msgDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        function addLoading() {
            var id = "loading-" + Date.now();
            var chatDiv = document.getElementById("chat-messages");
            var msgDiv = document.createElement("div");
            msgDiv.id = id;
            msgDiv.style.display = "flex";
            msgDiv.style.marginBottom = "10px";
            msgDiv.innerHTML = `<div style="background: white; padding: 10px 15px; border-radius: 15px 15px 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05);"><i class="fas fa-ellipsis-h" style="color: #aeb9cc; animation: pulse 1s infinite;"></i></div>`;
            chatDiv.appendChild(msgDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            return id;
        }
        function removeLoading(id) { var el = document.getElementById(id); if (el) el.remove(); }
    </script>
</body>
</html>