<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Booking</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        /* ... Keep your existing CSS exactly as it was ... */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        /* --- 1. BODY BACKGROUND (Fintech Blue) --- */
        body { 
            display: flex; 
            height: 100vh; 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            overflow: hidden; 
        }

        /* --- 2. SIDEBAR (Glass Effect) --- */
        .sidebar { 
            width: 90px; 
            background: rgba(0, 0, 0, 0.2); /* Dark Transparent */
            backdrop-filter: blur(12px);    /* Blur Effect */
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; flex-direction: column; align-items: center; padding: 30px 0; z-index: 100; 
        }

        /* Sidebar Icons (Light Color for Dark Background) */
        .sidebar-icon { 
            width: 50px; height: 50px; border-radius: 14px; 
            display: flex; justify-content: center; align-items: center; 
            color: #94a3b8; /* Light Gray */
            font-size: 1.3rem; margin-bottom: 25px; 
            text-decoration: none; position: relative; transition: all 0.3s ease; 
        }
        
        .sidebar-icon:hover { 
            background: rgba(255, 255, 255, 0.1); 
            color: #ffffff; 
            transform: translateY(-2px); 
        }
        
        .sidebar-icon.active { 
            background: linear-gradient(135deg, #4a6cf7 0%, #3451c7 100%); 
            color: white; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); 
        }
        
        .sidebar-icon.logout { margin-top: auto; color: #ff6b6b; } 
        .sidebar-icon.logout:hover { background: rgba(255, 85, 85, 0.1); color: #ff6b6b; }

        /* Tooltip */
        .sidebar-icon::after { content: attr(data-tooltip); position: absolute; left: 75px; top: 50%; transform: translateY(-50%) translateX(10px); background-color: #2d3436; color: white; padding: 6px 14px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; white-space: nowrap; opacity: 0; visibility: hidden; transition: 0.2s; pointer-events: none; z-index: 100; }
        .sidebar-icon:hover::after { opacity: 1; visibility: visible; transform: translateY(-50%) translateX(0); }

        /* --- 3. MAIN CONTENT --- */
        .main-content { 
            flex: 1; 
            padding: 40px; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            overflow-y: auto; 
            background: transparent; /* Transparent background */
        }
        
        /* FORM CONTAINER */
        .form-container { 
            background: white; width: 100%; max-width: 600px; padding: 50px; border-radius: 24px; margin-top: 20px; 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2); /* Darker shadow */
            border: 1px solid #f1f5f9; 
        }
        
        .form-header { margin-bottom: 30px; text-align: center; }
        .form-header h2 { font-size: 1.8rem; font-weight: 700; color: #1a1a1a; }
        .form-header p { color: #888; margin-top: 5px; font-size: 0.95rem; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 500; margin-bottom: 8px; color: #444; font-size: 0.9rem; }
        
        input, textarea, select { width: 100%; padding: 14px 18px; border: 2px solid #f0f0f0; border-radius: 12px; font-size: 0.95rem; background: #fafafa; transition: 0.3s; color: #333; font-family: 'Poppins', sans-serif; }
        input:focus, textarea:focus, select:focus { border-color: #4a6cf7; background: #fff; outline: none; }
        textarea { resize: none; }
        
        .btn-submit { width: 100%; padding: 16px; background: linear-gradient(135deg, #003366 0%, #4a6cf7 100%); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-submit:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(74, 108, 247, 0.3); }
        .btn-submit:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

        .select2-container .select2-selection--single { height: 52px !important; padding: 10px 15px !important; border: 2px solid #f0f0f0 !important; border-radius: 12px !important; background-color: #fafafa !important; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 50px !important; right: 15px !important; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 28px !important; color: #333 !important; font-size: 0.95rem; }

        #availability-status { font-size: 0.9rem; font-weight: 600; margin-top: 5px; min-height: 24px; display: flex; align-items: center; gap: 8px; }
        .status-available { color: #16a34a; }
        .status-taken { color: #dc2626; }
        .status-checking { color: #64748b; }

        .hidden-field { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <a href="{% url 'dashboard' %}" class="sidebar-icon" data-tooltip="Dashboard"><i class="fas fa-home"></i></a>
        <a href="{% url 'my_bookings' %}" class="sidebar-icon" data-tooltip="My Bookings"><i class="fas fa-list-ul"></i></a>
        <a href="{% url 'calendar' %}" class="sidebar-icon" data-tooltip="View Schedule"><i class="fas fa-calendar-alt"></i></a>
        <a href="{% url 'venue_list' %}" class="sidebar-icon" data-tooltip="Campus Venues"><i class="fas fa-map-marker-alt"></i></a>
        <a href="#" class="sidebar-icon active" data-tooltip="Book a Venue"><i class="fas fa-plus"></i></a>
        <a href="{% url 'profile' %}" class="sidebar-icon" data-tooltip="Settings"><i class="fas fa-user-cog"></i></a>
        <a href="{% url 'logout' %}" class="sidebar-icon logout" data-tooltip="Log Out"><i class="fas fa-sign-out-alt"></i></a>
    </div>

    <div class="main-content">
        <div class="form-container">
            <div class="form-header">
                <h2>Book a Venue</h2>
                <p>Reserve a space for your next event.</p>
            </div>

            <form method="post" id="bookingForm" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="form-group">
                    <label>Booking Purpose</label>
                    <select name="purpose" id="id_purpose" class="form-control" style="height: 52px;">
                        <option value="STUDY">Study Session</option>
                        <option value="EVENT">Event / Activity</option>
                    </select>
                </div>

                <div class="form-group hidden-field" id="event-name-group">
                    <label>Event Name</label>
                    {{ form.event_name }}
                </div>

                <div class="form-group">
                    <label>Venue</label>
                    {{ form.venue }}
                </div>

                <div class="form-group">
                    <label>Description</label>
                    {{ form.description }}
                </div>

                <div class="form-group">
                    <label><i class="fas fa-plug" style="margin-right: 5px; color: #4a6cf7;"></i> Add-on Equipment (Optional)</label>
                    {{ form.addon_equipment }}
                    <small style="color: #94a3b8; font-size: 0.85rem; margin-top: 4px; display: block;">
                        Need extras? List items like: 1x Mic, HDMI Cable, 2x Whiteboard Markers.
                    </small>
                </div>
                
                <div class="form-group hidden-field" id="document-group">
                    <label>Upload Document (Optional)</label>
                    {{ form.document }}
                </div>

                <div class="form-group" style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label>Start Time</label>
                        <input type="text" id="id_start_time" name="start_time" class="datetime-picker" placeholder="Select Date & Time" value="{{ form.start_time.value|default:'' }}" required>
                    </div>
                    <div style="flex: 1;">
                        <label>End Time</label>
                        <input type="text" id="id_end_time" name="end_time" class="datetime-picker" placeholder="Select Date & Time" value="{{ form.end_time.value|default:'' }}" required>
                    </div>
                </div>

                <div class="form-group">
                    <div id="availability-status"></div>
                </div>
                
                <button type="submit" id="submitBtn" class="btn-submit">Confirm Booking</button>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        $(document).ready(function() {
            // Select2
            $('#id_venue').select2({ width: '100%', placeholder: "Select a Venue...", allowClear: true });

            // Date Pickers
            let baseConfig = { 
                enableTime: true, 
                dateFormat: "Y-m-d H:i", 
                time_24hr: true,
                onClose: function() { checkAvailability(); } 
            };
            flatpickr("#id_start_time", baseConfig);
            flatpickr("#id_end_time", baseConfig);

            // Toggle Fields
            function toggleFields() {
                var purpose = $('#id_purpose').val();
                if (purpose === 'EVENT') {
                    $('#event-name-group').slideDown();
                    $('#document-group').slideDown();
                } else {
                    $('#event-name-group').slideUp();
                    $('#document-group').slideUp();
                }
            }
            $('#id_purpose').change(toggleFields);
            toggleFields(); 

            // Availability Check
            $('#id_venue').on('change', checkAvailability);
            
            function checkAvailability() {
                const venue = $('#id_venue').val();
                const start = $('#id_start_time').val();
                const end = $('#id_end_time').val();
                const statusDiv = $('#availability-status');
                const btn = $('#submitBtn');

                if (venue && start && end) {
                    statusDiv.html('<span class="status-checking"><i class="fas fa-spinner fa-spin"></i> Checking availability...</span>');
                    btn.prop('disabled', true);

                    $.ajax({
                        url: "{% url 'check_availability' %}",
                        data: { 'venue_id': venue, 'start_time': start, 'end_time': end },
                        dataType: 'json',
                        success: function (data) {
                            if (data.status === 'available') {
                                statusDiv.html('<span class="status-available"><i class="fas fa-check-circle"></i> Venue is Available!</span>');
                                btn.prop('disabled', false); 
                            } else {
                                statusDiv.html('<span class="status-taken"><i class="fas fa-times-circle"></i> Venue is Busy at this time.</span>');
                                btn.prop('disabled', true); 
                            }
                        },
                        error: function() {
                            statusDiv.html('<span class="status-checking">Error connecting to server.</span>');
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>